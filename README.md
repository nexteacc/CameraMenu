# CameraMenu - 菜单翻译应用

这是一个基于 Next.js 15.2.0 开发的现代化 Web 应用，主要功能是拍摄菜单照片并将其翻译成不同语言。项目采用了 React 19.0.0 和 TypeScript，并使用了 Tailwind CSS 进行样式设计。

## 项目架构

项目采用了 Next.js 的 App Router 架构，主要文件和目录结构如下：

- `/app` - 包含应用的主要页面和布局
- `/components` - 包含可复用的 UI 组件
- `/lib` - 包含工具函数
- `/public` - 包含静态资源

## 核心功能

1. **用户认证**：使用 Clerk 进行用户认证，包括登录和登出功能。

2. **相机拍照**：通过浏览器的 MediaDevices API 访问设备相机，拍摄菜单照片。

3. **图片翻译**：将拍摄的菜单照片上传到后端服务，进行 OCR 识别和翻译处理。

4. **多语言支持**：支持将菜单翻译成多种语言，包括中文、英文、日文、韩文、法文、德文、西班牙文和俄文。

5. **异步任务处理**：支持异步翻译任务，通过轮询机制获取翻译结果。

## 主要组件

1. **CameraButton**：启动相机的按钮组件，处理相机权限请求和错误处理。

2. **CameraView**：相机视图组件，负责显示相机预览、拍照和处理图像数据。

3. **ResultsView**：结果显示组件，展示翻译后的图片和可能的错误信息。

4. **LanguageSelector**：语言选择器组件，允许用户选择目标翻译语言。

5. **AuroraBackground**：提供美观的渐变背景效果的组件，增强用户体验。

## 工作流程

1. 用户登录应用
2. 选择目标翻译语言
3. 点击相机按钮启动相机
4. 拍摄菜单照片
5. 应用将照片上传到后端服务
6. 后端服务进行 OCR 识别和翻译处理
7. 应用显示翻译结果或错误信息
8. 用户可以重新拍摄或返回主页

## 技术特点

1. **响应式设计**：使用 Tailwind CSS 实现响应式 UI，适配不同设备。

2. **状态管理**：使用 React 的 useState 和 useCallback 钩子管理应用状态。

3. **异步处理**：使用 async/await 和 Promise 处理异步操作，如相机访问和 API 请求。

4. **错误处理**：全面的错误处理机制，包括相机权限错误、网络错误和翻译错误。

5. **动画效果**：使用 framer-motion 库实现平滑的 UI 动画效果。

## 移动端适配

项目在设计时充分考虑了移动端适配，通过 Tailwind CSS 的响应式类和合理的布局设计，可以在不同尺寸的设备上提供良好的用户体验。特别是相机功能和结果显示部分，都针对移动设备做了特定优化：

- 使用了响应式布局类如 `min-h-screen`、`w-full`、`max-w-2xl` 等
- 相机视图使用了 `aspect-[3/4]` 保持固定比例
- 视频和图片元素使用 `object-cover` 确保内容在不同尺寸的容器中正确显示
- 视频元素使用了 `playsInline` 和 `webkit-playsinline="true"` 属性，针对 iOS 设备优化
- 相机请求使用了 `facingMode: "environment"` 配置，优先使用后置相机

## API 集成

应用通过 RESTful API 与后端服务通信，主要包括：

1. 图片上传 API：`/api/upload`
2. 翻译任务状态查询 API：`/api/task/{taskId}`

后端 API 基于文档中描述的翻译 API 实现，支持文档翻译和图片翻译功能。

## 开发与运行

```bash
# 安装依赖
pnpm install

# 开发模式运行
pnpm dev

# 构建生产版本
pnpm build

# 运行生产版本
pnpm start
```

## 环境变量

项目需要以下环境变量：

- `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` - Clerk 认证服务的公钥
- `NEXT_PUBLIC_API_BASE_URL` - 后端 API 的基础 URL



# 菜单翻译改造方案

## 后端
- 前端拍照后，将图片直接上传到自家后端。
- 后端收到图片后，携带密钥向 simplifyai.cn 发起请求，获取翻译结果。
- 后端将翻译结果返回给前端。

---



---

### 前端开发任务拆解
1. 图片上传流程重构：将原有直接上传到 Cloudinary 的逻辑，改为上传到后端，由后端统一处理图片存储和分析。
2. 目标语言选择交互：增加目标语言选择的 UI 组件（如下拉框、按钮组等），支持用户选择如“中文”、“英文”等目标语言，并将选择结果作为 `targetLang` 字段传递给后端。
3. 移动端适配与交互优化：确保拍照、预览、结果展示等流程在主流手机浏览器下流畅、易用。
4. 结果页结构调整：结果页面（ResultsView）将优化为仅展示翻译后图片，操作区包含重拍、切换语言、下载图片等按钮，支持移动端适配。
5. 与后端接口契约定义：明确图片上传、分析、结果获取等接口的参数、返回值、鉴权方式。
6. 用户体验与异常处理完善：包括加载态、错误提示、重试机制等。

---

## 后端接口设计要点

1. 图片上传与分析接口：
   - 参数：图片数据（base64 或文件）、userId、targetLang
   - 返回：分析结果、错误信息等
   - 鉴权：校验前端传递的用户 token，解析 userId
2. 结果获取接口（如有异步分析需求）：
   - 参数：任务ID、userId
   - 返回：分析结果、进度、错误信息等
3. 安全与防滥用：
   - 限制单用户并发请求数、图片大小和类型
   - 日志记录与异常告警
   - 其他防止接口被滥用的措施

---

### 图片上传与分析接口与结果获取接口字段与数据流设计（参考文档翻译API）

#### 1. 图片上传与分析接口
- 接口路径：`/api/upload`
- 请求方式：POST
- 请求头：
  - Authorization: Bearer <token>（强制，安全认证）
  - Content-Type: multipart/form-data
- 请求参数：
  - image（必填）：图片文件，multipart/form-data
  - userId（必填）：用户ID，字符串
  - targetLang（必填）：目标语言，字符串（如 "zh", "en"）
  - clientTaskId（可选）：客户端自定义任务ID，便于幂等和异常恢复
  - fastCreation（可选）：布尔值，true 时立即返回任务ID并异步处理，false 时同步处理
  - webhookUrl（可选）：任务完成后回调通知地址
  - 其他可选参数可参考文档翻译API，如模型选择、OCR 强制、图片翻译开关等
- 返回值：
  - taskId：任务ID，字符串
  - status：任务状态（如 Analyzing、Processing、Completed、Failed）
  - result（可选）：同步处理时直接返回分析和翻译结果（如菜单结构、翻译文本等 JSON）
  - progress（可选）：任务进度，0~100
  - error（可选）：错误信息
- 异常返回：
  - 401：未授权或 token 无效
  - 400：参数不全或格式错误
  - 429：请求过于频繁
  - 500：服务器内部错误

#### 2. 结果获取接口
- 接口路径：`/api/task/{taskId}/result` 或 `/api/task/{taskId}`
- 请求方式：GET
- 请求头：Authorization: Bearer <token>
- 请求参数：
  - taskId（必填）：任务ID，路径参数
  - withTexts（可选）：是否返回详细文本结构
  - textsInArray（可选）：返回格式为数组
- 返回值：
  - taskId：任务ID
  - status：任务状态（如 Processing、Completed、Failed）
  - progress：进度，0~100
  - originalFileUrl：原图片URL
  - translatedFileUrl：翻译后图片或文档URL（如有）
  - result：分析和翻译结果（如菜单结构、文本对、翻译内容等 JSON）
  - error：错误信息
- 异常返回：
  - 401：未授权
  - 404：任务不存在或无权限
  - 500：服务器错误

#### 3. 数据流说明
- 前端上传图片及参数，后端验证用户身份，校验并存储图片，返回任务ID。
- 后端使用开发者 API Token 调用第三方翻译 API 处理图片。
- 若为异步处理，前端可通过轮询或回调获取进度和结果。
- 结果接口返回详细分析和翻译内容，结构可参考文档翻译API的 texts 字段设计。

#### 4. 合理性分析
- 字段设计与主流API一致，便于扩展和维护。
- 支持同步/异步混合，适应不同场景。
- 认证、幂等、错误处理机制完善。
- 结果结构灵活，兼容多种前端展示需求。

#### 5. 认证流程设计
- **前端认证**：
  - 使用Clerk进行用户认证，每个用户拥有独特的Session Token
  - 前端在调用后端API时，在请求头中携带用户的Session Token
  - 使用FormData格式上传图片文件和其他参数

- **后端认证**：
  - 后端接收请求后，使用Clerk SDK验证前端提供的用户Token
  - 验证通过后，后端使用安全存储的开发者API Token调用第三方翻译API
  - 后端作为中转站，保护第三方API Token不被前端暴露

- **认证流程示例**：
  1. 用户通过Clerk登录应用，获取Session Token
  2. 用户拍摄图片并选择目标语言
  3. 前端将图片、目标语言和用户Session Token发送到后端
  4. 后端验证用户Token有效性
  5. 后端使用开发者API Token调用第三方翻译API
  6. 后端将翻译结果返回给前端
  7. 前端展示翻译结果

- **安全性考虑**：
  - 开发者API Token仅存储在后端，不暴露给前端
  - 用户Session Token用于验证用户身份，确保请求来自合法用户
  - 后端实施请求频率限制，防止API滥用


# 开发任务优先级



## 第一阶段（核心功能）
1. 修改handleCapture函数 ：改为直接上传到后端
   - 使用FormData格式上传图片文件
   - 在请求头中添加用户认证Token
   - 添加必要参数（targetLang, userId等）
2. 添加语言选择组件 ：简单的下拉框或按钮组
3. 调整ResultsView组件 ：展示翻译后的图片
4. 更新接口调用逻辑 ：适配新的后端接口
   - 实现轮询机制获取翻译结果
   - 处理各种状态和错误情况


## 第二阶段（体验优化）
1. 移动端交互优化 ：确保语言选择和结果展示在手机上友好
2. 添加下载功能 ：支持下载翻译后的图片
3. 完善错误处理 ：针对翻译API的特定错误
4. 加载状态优化 ：显示翻译进度



# UI界面设计
### 1. 主页/登录页面
- 未登录状态 ：显示Clerk提供的登录界面
- 已登录状态 ：
  - 顶部显示"菜单翻译"标题和简短描述
  - 中间是语言选择器下拉框，支持多种语言（中文、英文、日文、韩文、法文、德文、西班牙文、俄文等）
  - 下方是一个蓝色的"START"相机按钮
  - 底部有退出登录按钮
  - 整个界面使用AuroraBackground组件提供渐变背景效果


  ### 2. 相机视图界面
- 占据大部分屏幕的相机预览窗口，比例为3:4
- 底部有两个按钮：
  - 返回按钮（左侧）
  - 拍照按钮（右侧）
- 拍照后会显示加载动画


### 3. 结果展示界面
- 顶部有返回按钮和"翻译结果"标题
- 中间显示翻译后的图片
- 图片下方显示当前翻译语言和语言选择下拉框
- 如有错误，会显示错误信息和重试按钮
- 底部有"重新拍照"按钮